<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="apple-moblie-web-app-capable" content="yes">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>MIXLAB-NAME-CARD</title>
    <script src="https://cdn.bootcss.com/fabric.js/2.3.0/fabric.min.js"></script>
    <script src="../js/mix-words.js"></script>
    <link rel="stylesheet" href="../css/mix.css">
    <style>
        #main {

            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 12;
            display: none;
            text-align: center;
        }
    </style>
</head>

<body class="mix-contarner">
    <div class="mix-pannel" id="mix-input">

        <p class="mix-title">头像</p>
        <div class="mix-avatar-upload"></div>
        <input class="mix-input" type="file" id="avatar" style="display: none">

        <p class="mix-title">信息</p>
        <input class="mix-input" type="text" id="name" placeholder="姓名">
        <input class="mix-input" type="text" id="title" placeholder="职位／身份">

        <textarea class="mix-textarea" name="" id="detail" cols="20" rows="10" placeholder="个人详细介绍(选填）"></textarea>

        <br>
        <br>
        <br>
        <br>

        <p>by MIXLAB</p>

    </div>

    <div class="mix-btn-bottom">
        <button class="mix-btn" onclick="start();" id="start">生成日签／名片</button>
    </div>


    <div id="loading">
        <h4>Loading</h4>
    </div>
    <div id="main">


    </div>
</body>

<script>
    var mixWord = new MixWord();

    var urlOpts = getOpts();

    var cardFrom = cardFromUrl(urlOpts.from);

    function getOpts() {
        var url = window.location.href;
        var isOpts = url.indexOf('?');

        if (isOpts != -1) {

            var opts = url.slice(isOpts + 1, url.length).split('&');
            var obj = {};

            for (var i = 0; i < opts.length; i++) {
                var ks = opts[i].split('=');
                obj[ks[0]] = ks[1];
            };

        };

        return obj
    };

    function cardFromUrl(_from) {
        if (_from == 'cot') {
            return '../img/name_card_cot.svg'
        } else if (_from == 'mixlab') {
            return '../img/name_card.svg'
        };
    };






    var isInput = true;
    var nameEl = document.getElementById('name'),
        titleEl = document.getElementById('title'),
        detailEl = document.getElementById('detail'),
        avatarEl = document.getElementById('avatar'),
        avatar_displayEl = document.querySelector('.mix-avatar-upload');

    var startEl = document.getElementById('start'),
        loadingEl = document.getElementById('loading');

    var inputDiv = document.getElementById('mix-input'),
        mainDiv = document.getElementById('main');

    var avatar = null;
    avatarEl.addEventListener('change', handleFiles);
    avatar_displayEl.addEventListener('click', function () {
        avatarEl.click();
    });

    var userInputOld = localStorage.getItem('userInput') ? JSON.parse(localStorage.getItem('userInput')) : null;

    if (userInputOld != null) {
        nameEl.value = userInputOld.name;
        titleEl.value = userInputOld.title;
    };

    function handleFiles(files) {
        //  console.log(files)
        if (files.target.files.length > 0) {
            var file = files.target.files[0];
            if (
                typeof FileReader !== 'undefined' &&
                file.type.indexOf('image') != -1
            ) {
                var reader = new FileReader();
                // Note: addEventListener doesn't work in Google Chrome for this event
                reader.onload = function (evt) {
                    load(evt.target.result);
                };
                reader.readAsDataURL(file);
            }
        }
    };

    function load(src) {
        //   console.log(src)
        var avatarSize = 240;
        var img = new Image();
        img.onload = function () {
            smartcrop.crop(img, {
                width: avatarSize,
                height: avatarSize
            }).then(function (result) {
                // console.log(result);
                var selectedCrop = result.topCrop;
                var can = document.createElement('canvas'),
                    c = can.getContext('2d');
                can.width = avatarSize;
                can.height = avatarSize;
                c.fillStyle = "black";
                c.fillRect(0, 0, avatarSize, avatarSize);
                c.drawImage(img, selectedCrop.x, selectedCrop.y, selectedCrop.width, selectedCrop.height, 0,
                    0, can.width, can.height);
                //  console.log(can)
                var imgNew = new Image();
                imgNew.src = can.toDataURL();
                avatar = imgNew;
                avatar_displayEl.style.backgroundImage = 'url(' + imgNew.src + ')';
                //document.body.appendChild(imgNew)
            });


        };
        img.src = src;
    };

    function start() {
        if (isInput) {
            create();
            startEl.innerText = '再做一张';
        } else {
            newInput();
            startEl.innerText = '生成名片';
        };
    };

    function newInput() {
        isInput = true;
        inputDiv.style.display = 'block';
        mainDiv.style.display = 'none';
        mainDiv.innerHTML = '';
    }

    function create() {
        isInput = false;
        inputDiv.style.display = 'none';
        mainDiv.style.display = 'block';
        loadingEl.style.display = 'block';

        var userInput = {
            name: nameEl.value || 'MixLearner',
            title: titleEl.value || '社区成员',
            detail: detailEl.value || mixWord.getWord(),
            avatar: avatar||'none'
        };

       // console.log(userInput)

        localStorage.setItem('userInput', JSON.stringify(userInput));

        var canvasEl = document.createElement('canvas');
        var canvas = new fabric.Canvas(canvasEl);

        fabric.loadSVGFromURL(cardFrom, function (objects, options) {
            var obj = fabric.util.groupSVGElements(objects, options);
            canvas.setWidth(obj.width);
            canvas.setHeight(obj.height);
            canvas.setBackgroundColor('black');


            //  console.log(obj)

            var objs = obj.getObjects();
            // console.log(avatar)
            for (var i = 0; i < objs.length; i++) {

                var id = objs[i].id;
                if (userInput[id]) {
                    //  console.log(objs[i].height);
                    if (id == 'name') {
                        var text = new fabric.Text(userInput[id].slice(0, 12), {
                            fill: 'white',
                            left: objs[i].left,
                            top: objs[i].top,
                            fontSize: objs[i].height * 1.1,
                            fontFamily: 'Noto-Light',
                            fontWeight: 700,
                        });
                        objs[i].visible = false;
                        obj.add(text);
                    } else if (id == "title") {

                        var texts = userInput[id].slice(0, 24);
                        var textNew = StringInsertByInterval(texts, '\n', 14);

                        var text = new fabric.Text(textNew, {
                            fill: 'white',
                            left: objs[i].left,
                            top: objs[i].top + 30,
                            fontSize: objs[i].height * 0.6,
                            fontFamily: 'Noto-Light',
                            fontWeight: 100
                        });
                        objs[i].visible = false;
                        obj.add(text);
                    } else if (id == "detail") {
                        var fontSize = ~~objs[i].width * 0.08;
                        var texts = userInput[id].slice(0, 240);;
                        var textNew = StringInsertByInterval(texts, '\n', 12);
                        //   console.log(textNew, texts)


                        var text = new fabric.Text(textNew, {
                            fill: 'white',
                            left: objs[i].left,
                            top: objs[i].top + 30,
                            fontSize: fontSize,
                            width: objs[i].width,
                            lineHeight: 1.2,
                            textAlign: 'left',
                            fontFamily: 'Noto-Light',
                            fontStyle: 'Italic',
                            charSpacing: fontSize,
                            fontWeight: 100
                        });
                        objs[i].visible = false;
                        // console.log(text)
                        obj.add(text);
                    } else if (id == 'avatar') {
                       
                        if (userInput.avatar != 'none') {
                            var imgInstance = new fabric.Image(userInput.avatar, {
                                left: objs[i].left,
                                top: objs[i].top,
                                width: objs[i].width
                            });
                            objs[i].visible = false;
                            //   console.log(imgInstance)
                            obj.add(imgInstance);
                        } else {

                            objs[i].visible = false;

                            var fontSize=objs[i].height*0.5;
                            var _date=new Date();
                            var _day=_date.getDate().toString(),_month=(_date.getMonth()+1).toString();
                            if (_day.length==1) {
                                _day='0'+_day;
                            };
                            if (_month.length==1) {
                                _month='0'+_month;
                            };

                            var _yearMonth=_date.getFullYear()+'/'+_month;
                            
                            var _top=objs[i].top+44;

                            var text = new fabric.Text(_day, {
                                fill: 'white',
                                left: objs[i].left,
                                top: _top,
                                fontSize: fontSize,
                                width: objs[i].width,
                                lineHeight: 1.2,
                                textAlign: 'left',
                                fontFamily: 'Noto-Light',
                                fontStyle: 'Italic',
                                fontWeight: 100
                            });
                            
                            // console.log(text)
                            obj.add(text);

                            var text2 = new fabric.Text(_yearMonth, {
                                fill: 'white',
                                left: objs[i].left,
                                top: _top+ fontSize,
                                fontSize: fontSize*0.3,
                                width: objs[i].width,
                                lineHeight: 1.2,
                                textAlign: 'left',
                                fontFamily: 'Noto-Light',
                                fontStyle: 'Italic',
                                charSpacing: fontSize*0.3,
                                fontWeight: 100
                            });
                            
                            // console.log(text)
                            obj.add(text2);



                        };



                    };

                 

                };

            };

            canvas.add(obj);
            // console.log(canvas)

            var ImageRes = new Image();
            ImageRes.style.height = "70%";
            ImageRes.style.marginTop = "2em";

            ImageRes.src = canvas.toDataURL();

            mainDiv.appendChild(ImageRes);
            var a = document.createElement('a');
            a.innerText = '长按图片保存\nMIXLAB提供技术支持';
            a.className = "mix-info";
            a.href = "./index.html";

            mainDiv.appendChild(a);
            loadingEl.style.display = "none";

        });
    };


    function StringInsertByInterval(oc, ic, re) {

        var reStr = "(.{" + re + "}|.*)";

        var reg = new RegExp(reStr, "g");

        var ocArray = oc.match(reg);
        ocArray.pop();

        var arrLength = ocArray.length + 1;

        for (var element = 0; element < ocArray.length; element += 2) {

            ocArray.splice(element + 1, 0, ic);

        }
        ocArray.pop();
        var str = ocArray.join('');
        return str;
    };

 
</script>

<script src="https://cdn.bootcss.com/smartcrop/2.0.3/smartcrop.min.js"></script>

</html>